# Incentives API

Lifts the javascript logic from policy-hub and packages it up with Fastify.

Exposes /api/v1/calculator and describes query params and responses using OpenAPI.

Includes scripts to import data into a sqlite database.

## Architecture

The node.js file is packaged in a Docker container to allow installing sqlite in Cloud Run.

The Cloud Run services are not intended to be hit directly, we use zuplo.com as an API gateway. Zuplo performs the following functions for us:
 - documentation generation and hosting at /docs
 - API key management and authentication (and tracking for leaks)
 - rate limiting
 - CORS support for browsers

In production, this app responds to api.rewiringamerica.org via a CNAME that points to Zuplo.

At the moment, @tomc is the only team member with access to Zuplo at https://portal.zuplo.com/ - changes to configurations can also be made via git at https://github.com/rewiringamerica/incentives-api-zuplo

Zuplo authenticates developers using Auth0. @tomc, @derek, @tomm and @chell have access to Auth0.

## Local Development

Create a `.env` file containing the following variables:

```
GEOCODIO_API_KEY= # get from https://dash.geocod.io/apikey or ask @tomc
```

## Deploys

Container is deployable on Google Cloud Run with `yarn deploy:dev` or `yarn deploy:production`.

Pushing to `main` branch will build the `rewiring-america-dev` project automatically, but the build does not yet autodeploy.
Merging a pull request from `main` to `production` branch will build the production project automatically, but the build does not yet autodeploy.

## Scaling

 * `gcloud run services update incentives-api --project rewiring-america --min-instances 1 --max-instances 10 --concurrency 100`

See Google's [concurrency guide](https://cloud.google.com/run/docs/about-concurrency) to learn more.

## URLs

 - Production api.rewiringamerica.org --> Zuplo --> https://incentives-api-w4dlpicepa-uc.a.run.app
 - Staging Zuplo --> https://incentives-api-dev-mcifvvqcxa-uc.a.run.app

## TODO

https://app.asana.com/0/1203194244067918/1203657186427969/f

## Notes

Why fastify? Seems like included schema validation is clean. Was a sqlite example at glitch.com, just ran with it! https://www.fastify.io/docs/latest/

The OpenAPI spec generated by this project isn't 100% valid due to discrepancies between JSON Schema and Open API. These should be fixed in OpenAPI 3.1
 - https://openap.is/validate?url=http%3A%2F%2Fincentives-api-dev-mcifvvqcxa-uc.a.run.app%2Fspec.json

The schema generated by Zuplo seems good, but it doesn't validate either:
 - https://openap.is/validate?url=https%3A%2F%2Fcustomer-assets-production.zuplo.dev%2Fe0c4d415-2834-400c-b6fa-b9d212af7aa7%2Fopen-api%2Fapi%2Fv1%2Fopen-api.json


## References

 - https://cloud.google.com/files/apigee/apigee-web-api-design-the-missing-link-ebook.pdf
 - https://techbeacon.com/app-dev-testing/you-need-api-management-help-11-open-source-tools-consider
 - https://zuplo.com/blog/2022/12/01/api-key-authentication
 - https://blog.readme.com/http-api-faux-pas/
 - https://medium.com/@guillaume.viguierjust/building-a-multilingual-restful-api-2678add7febe
 - https://www.irs.gov/pub/irs-drop/n-23-17.pdf
 - https://www2.census.gov/geo/pdfs/reference/geodiagram.pdf

