# Incentives API

Lifts the javascript logic from policy-hub and packages it up with Fastify.

Exposes /api/v1/calculator and describes query params and responses using OpenAPI.

Includes scripts to import data into a sqlite database.

## Getting Started

Create a `.env` file containing the following variables:

```
GEOCODIO_API_KEY= # get from https://dash.geocod.io/apikey or ask @tomc
```

- `yarn` to install dependences
- `yarn build` to build schema
- `yarn dev` to run the api, then open `http://0.0.0.0:3000/api/v0/calculator?zip=80125&owner_status=renter&household_income=80000&tax_filing=joint&household_size=1`

## Architecture

The node.js file is packaged in a Docker container to allow installing sqlite in Cloud Run.
[Here's a system diagram.](https://docs.google.com/drawings/d/1nJBKFGSKcLmIPO4sz3ncZBii8HQw7YOF3kjKgyPblm4/edit)

The Cloud Run services are not intended to be hit directly, we use zuplo.com as an API gateway. Zuplo performs the following functions for us:

- documentation generation and hosting at /docs
- API key management and authentication (and tracking for leaks)
- rate limiting
- CORS support for browsers

In production, this app responds to api.rewiringamerica.org via a CNAME that points to Zuplo.

The Zuplo config lives in the [Zuplo portal](https://portal.zuplo.com); ask @tomc for access if necessary. The Zuplo config is version-controlled at https://github.com/rewiringamerica/api-zuplo; it can be edited there and synced to Zuplo via the portal.

Zuplo authenticates developers using Auth0. @tomc, @derek, @tomm and @chell have access to Auth0.

## Branching & Deploying

### Branching

When working on a new change, branch off of and merge PRs into `main`. Pushing to `main` will build and deploy the `incentives-api-dev` Cloud Run service in the `rewiring-america-dev` GCP project.

### Deploying

Pushing to the `production` branch will automatically build and deploy `incentives-api` Cloud Run service in the `rewiring-america` (prod) GCP project. The build/deploy steps are in [cloudbuild.yaml](cloudbuild.yaml).

Manual deploys to Google Cloud Run can be done with `yarn deploy:dev` or `yarn deploy:production`.

If any content changes affect the calculator we should update the website changelog (Contentful), and if the API changes might affect callers we should update the changelog in docs and consider emailing people with active keys. In the future, we probably need a mailing list to manage this, but for now we'll bcc and email from api@.

## Scaling

- `gcloud run services update incentives-api --project rewiring-america --min-instances 1 --max-instances 10 --concurrency 100`

See Google's [concurrency guide](https://cloud.google.com/run/docs/about-concurrency) to learn more.

## URLs

- Production api.rewiringamerica.org --> Zuplo --> https://incentives-api-w4dlpicepa-uc.a.run.app
- Zuplo working copy https://api-main-4ba10f3.d2.zuplo.dev --> https://incentives-api-dev-mcifvvqcxa-uc.a.run.app

## TODO

https://app.asana.com/0/1203194244067918/1203657186427969/f

## Notes

Why fastify? Seems like included schema validation is clean. Was a sqlite example at glitch.com, just ran with it! https://www.fastify.io/docs/latest/

The OpenAPI spec generated by this project isn't 100% valid due to discrepancies between JSON Schema and Open API. These should be fixed in OpenAPI 3.1

- https://openap.is/validate?url=http%3A%2F%2Fincentives-api-dev-mcifvvqcxa-uc.a.run.app%2Fspec.json

The schema generated by Zuplo seems good, but it doesn't validate either:

- https://openap.is/validate?url=https%3A%2F%2Fcustomer-assets-production.zuplo.dev%2Fe0c4d415-2834-400c-b6fa-b9d212af7aa7%2Fopen-api%2Fapi%2Fv1%2Fopen-api.json

## References

- https://cloud.google.com/files/apigee/apigee-web-api-design-the-missing-link-ebook.pdf
- https://techbeacon.com/app-dev-testing/you-need-api-management-help-11-open-source-tools-consider
- https://zuplo.com/blog/2022/12/01/api-key-authentication
- https://blog.readme.com/http-api-faux-pas/
- https://medium.com/@guillaume.viguierjust/building-a-multilingual-restful-api-2678add7febe
